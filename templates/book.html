{% extends "index.html" %}

{% block title %}Book {{ room.name }} - {{ hostel.hostel_name }}{% endblock %}

{% block content %}
<section id="book-room-section" class="book-room-section py-5">
    <div class="container">
        <h2 class="section-title">Book <span>{{ room.name }}</span></h2>

        <div class="booking-form-container">
            <div class="room-summary">
                <h3>Room Details</h3>
                {# Access images via helper method #}
                <img src="{{ room.get_images()[0] if room.get_images() else 'https://placehold.co/400x300/6c5ce7/ffffff?text=Room+Image' }}" alt="{{ room.name }}">
                <p><strong>Name:</strong> {{ room.name }}</p>
                <p><strong>Capacity:</strong> {{ room.capacity }} Person{% if room.capacity > 1 %}s{% endif %}</p>
                <p><strong>Price:</strong> GHC {{ "%.2f"|format(room.price_per_academic_year) }} / Academic Year</p>
                <p><strong>Available:</strong> {{ room.available_rooms }}</p>
                <p>{{ room.description }}</p>
                <div class="amenities-preview">
                    <h4>Amenities:</h4>
                    <ul>
                        {% for amenity in room.get_amenities() %} {# Access amenities via helper method #}
                            <li><i class="fas fa-check-circle"></i> {{ amenity }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="booking-form">
                <h3>Your Booking Information</h3>
                <form id="bookingForm"> {# Changed action and method will be handled by JS #}
                    <div class="form-group">
                        <label for="check_in_date">Check-in Date:</label>
                        <input type="date" id="check_in_date" name="check_in_date" required>
                    </div>

                    <div class="form-group">
                        <label for="check_out_date">Check-out Date:</label>
                        <input type="date" id="check_out_date" name="check_out_date" required>
                    </div>

                    <div class="form-group">
                        <label for="payment_method">Payment Method:</label>
                        <select id="payment_method" name="payment_method" required>
                            <option value="">Select Payment Method</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="mobile_money">Mobile Money (Ghana)</option>
                            <option value="bank_transfer">Bank Transfer</option>
                        </select>
                    </div>

                    <button type="submit" class="btn primary" id="payButton">Proceed to Payment</button>
                    <p class="note">Note: This is a simulated payment process for demonstration purposes. Real payment integration would require secure third-party payment gateways.</p>
                </form>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
    {{ super() }} {# Keep existing scripts from index.html #}
    <script src="https://js.paystack.co/v1/inline.js"></script> {# Paystack SDK #}
    <!-- <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bookingForm = document.getElementById('bookingForm');
            const payButton = document.getElementById('payButton');
            const publicKey = "{{ paystack_public_key }}"; // Passed from Flask backend

            if (bookingForm && payButton && publicKey && publicKey !== 'pk_test_YOUR_PAYSTACK_PUBLIC_KEY') {
                bookingForm.addEventListener('submit', async function(event) {
                    event.preventDefault(); // Prevent default form submission

                    payButton.disabled = true;
                    payButton.textContent = 'Processing...';

                    const formData = new FormData(bookingForm);
                    const room_id = {{ room.id }}; // Get room ID from Jinja context

                    try {
                        // Step 1: Initialize transaction on your Flask backend
                        const response = await fetch(`/book/${room_id}`, {
                            method: 'POST',
                            body: formData // Send form data to Flask
                        });

                        const data = await response.json();

                        if (data.status === 'success') {
                            // Step 2: Open Paystack Checkout
                            const handler = PaystackPop.setup({
                                key: publicKey,
                                email: "{{ current_user.email }}", // User's email from Flask-Login
                                amount: {{ (room.price_per_academic_year * 100) | int }}, {# MODIFIED: Added |int filter #}
                                ref: data.reference, // Unique reference from your backend
                                metadata: {
                                    custom_fields: [
                                        {
                                            display_name: "Booking ID",
                                            variable_name: "booking_id",
                                            value: data.metadata ? data.metadata.booking_id : ''
                                        },
                                        {
                                            display_name: "Room ID",
                                            variable_name: "room_id",
                                            value: room_id
                                        }
                                    ]
                                },
                                callback: function(response){
                                    // This is called after payment is successful or closed by user
                                    // The response.reference is the transaction reference
                                    window.location.href = `/paystack/callback?reference=${response.reference}`;
                                },
                                onClose: function(){
                                    // User closed the popup without completing payment
                                    alert('Payment window closed. Please try again.');
                                    payButton.disabled = false;
                                    payButton.textContent = 'Proceed to Payment';
                                }
                            });
                            handler.openIframe(); // Open the Paystack popup

                        } else {
                            alert(`Error: ${data.message || 'Payment initialization failed on server.'}`);
                            payButton.disabled = false;
                            payButton.textContent = 'Proceed to Payment';
                        }
                    } catch (error) {
                        console.error('Error during payment initialization:', error);
                        alert('An error occurred. Please check your console and try again.');
                        payButton.disabled = false;
                        payButton.textContent = 'Proceed to Payment';
                    }
                });
            } else {
                console.error("Paystack Public Key is missing or invalid. Check your Render environment variables.");
                if (payButton) {
                    payButton.disabled = true;
                    payButton.textContent = 'Payment Not Configured';
                }
            }
        });
    </script>
{% endblock %} -->
